<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Veritas WhatsApp Reminder - Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <style>
    body {
      background: #f9f9f9;
      font-family: 'Segoe UI', sans-serif;
    }

    /* Header */
    .topbar {
      background: #9b0d19;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .topbar h3 {
      margin: 0;
      font-size: 1.3rem;
    }

    /* User + Power Button */
    .topbar .user-power {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .topbar strong {
      font-size: 1rem;
    }

    /* Power Button */
    .btn-power {
      background: transparent;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      text-decoration: none;
      transition: 0.3s;
    }

    .btn-power img {
      width: 100px;
      height: 30px;
    }

    .btn-power:hover {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
    }

    /* Card Header */
    .card-header {
      background: #9b0d19;
      color: #fff;
      font-weight: bold;
    }

    /* Logs Table */
    #logContainer {
      border: 1px solid #ddd;
      border-radius: 8px;
      height: 280px;
      overflow-y: auto;
      background: #fff;
      font-family: "Segoe UI", "Roboto Mono", monospace;
      font-size: 14px;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
    }

    #logContainer table {
      width: 100%;
      border-collapse: collapse;
    }

    #logContainer th {
      background: #fc9301;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
      font-size: 13px;
      padding: 6px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    #logContainer td {
      padding: 6px;
      border-bottom: 1px solid #eee;
    }

    #logContainer tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }

    #logContainer tbody tr:nth-child(even) {
      background-color: #fdd081;
    }

    #logContainer tr.success td {
      color: #00bd45;
      font-weight: 500;
    }

    #logContainer tr {
      height: 40px;
    }

    /* Unified Button Style */
    .btn-custom {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none !important;
      outline: none !important;
      border-radius: 6px !important;
      font-weight: 600;
      cursor: pointer;
      padding: 10px 20px;
      color: #fff !important;
      margin-right: 10px;
      box-shadow: 1px 2px 4px rgba(0, 0, 0, 0.2);
      transition: background 0.2s ease-in-out;
      text-decoration: none !important;
      font-size: 15px;
    }

    .btn-start {
      background: #009200;
    }

    .btn-start:hover {
      background: #003411be;
    }

    .btn-stop {
      background: #dc3545;
    }

    .btn-stop:hover {
      background: #b02a37;
    }

    .container {
      max-width: 98% !important;
    }

    footer {
      padding: 10px;
      background: #eee;
      text-align: center;
      font-size: 0.85rem;
      margin-top: 20px;
    }

    footer a {
      font-weight: bold;
      text-decoration: none;
      color: #000;
    }
  </style>
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <h3>WhatsApp Reminder</h3>
    <div class="user-power">
      <a href="{{ url_for('logout') }}" class="btn-power" title="Logout">
        <img src="{{ url_for('static', filename='power1.png') }}" alt="Logout">
      </a>
    </div>
  </div>

  <!-- Content -->
  <div class="container mt-4">
    <div class="card shadow">
      <div class="card-body">
        <form method="POST" enctype="multipart/form-data" class="mb-3">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">Select Excel File:</label>
              <input type="file" name="file" accept=".xlsx,.xls" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Skip Loan Numbers:</label>
              <input type="text" name="skip_loans" placeholder="LAWCGNT123, LAWCGNT456" class="form-control"
                value="{{ skip_loans }}">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">Min Wait (sec):</label>
              <input type="number" name="sleep_min" value="{{ sleep_min }}" min="1" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Max Wait (sec):</label>
              <input type="number" name="sleep_max" value="{{ sleep_max }}" min="1" class="form-control">
            </div>
          </div>

          <!-- Start / Stop Buttons -->
          <button type="submit" class="btn-custom btn-start">
            üöÄ Start Sending
          </button>

          <a href="{{ url_for('stop') }}" class="btn-custom btn-stop">
            üõë Stop Sending
          </a>
        </form>
      </div>
    </div>

    <!-- Logs -->
    <div class="card shadow mt-4">
      <div class="card-header">üìä Live Logs</div>
      <div class="card-body">
        <div id="logContainer">
          <table>
            <thead>
              <tr>
                <th width="15%">‚è± Time (IST)</th>
                <th width="15%">üìå Status</th>
                <th>üìù Message</th>
                <th width="15%">üìä Progress</th>
                <th width="15%">‚è≥ Wait Time</th>
              </tr>
            </thead>
            <tbody id="logTable"></tbody>
          </table>
        </div>
        <div class="mt-2">
          ‚úÖ <span id="counter">0</span> / <span id="total">{{ total_customers }}</span> messages sent
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    Developed by <strong><a href="mailto:kona.krishna1997@gmail.com">Krishna</a></strong>
  </footer>

  <script>
    let sentCount = 0;
    const logTable = document.getElementById('logTable');
    const evtSource = new EventSource("/stream_logs");
    let tempRow = null;

    evtSource.onmessage = function (event) {
      const msg = event.data;

      if (msg.includes("Sent to")) {
        tempRow = document.createElement("tr");

        const tdTime = document.createElement("td");
        const tdStatus = document.createElement("td");
        const tdMsg = document.createElement("td");
        const tdProgress = document.createElement("td");
        const tdWait = document.createElement("td");

        const timeMatch = msg.match(/\[(.*?)\]/);
        tdTime.textContent = timeMatch ? timeMatch[1] : "-";

        tdMsg.textContent = msg.replace(/\[.*?\]\s*/, "");
        tdStatus.textContent = "Success";
        tdStatus.style.color = "green";

        tempRow.appendChild(tdTime);
        tempRow.appendChild(tdStatus);
        tempRow.appendChild(tdMsg);
        tempRow.appendChild(tdProgress);
        tempRow.appendChild(tdWait);

        logTable.appendChild(tempRow);
        logTable.parentElement.scrollTop = logTable.parentElement.scrollHeight;

        sentCount++;
        document.getElementById("counter").textContent = sentCount;
      }

      else if (msg.includes("Progress")) {
        if (tempRow) {
          // remove [timestamp]
          const cleanMsg = msg.replace(/\[.*?\]\s*/, "");
          // now cleanMsg will be only üìä 1 / 9 in progress
          const countOnly = cleanMsg.replace("in progress", "").trim();
          tempRow.children[3].textContent = countOnly; // only show "üìä 1 / 9"
        }
      }


      else if (msg.includes("Waiting")) {
        if (tempRow) {
          const waitMatch = msg.match(/(\d+)\s*seconds/);
          tempRow.children[4].textContent = waitMatch ? waitMatch[1] + "s" : "-";
        }
      }

      else if (msg.includes("Completed")) {
        evtSource.close();
      }
    };
  </script>
</body>

</html>
